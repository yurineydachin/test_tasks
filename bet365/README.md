Сканер лайв-версии сайта бет365 работает как клиент push-сервера diffusion.

Принцип работы:

1. Клиент коннектится к серверу и подписывается на главный топик лайва.

2. Получает дамп списка всех текущих матчей. Подписывается на каждый матч.

3. Получает дамп каждого матча, выдергивает инфу и преобразовывает.

4. Все остальное время получает из очереди изменения, накладывает их на дамп и периодически сохраняет текущее состояние всех матчей.

5. При появлении новых матчей подписывается на них, при завершении - отписывается.


Особенности:
1. Поскольку нельзя подписаться одновременно сразу более чем на 50 матчей (диффужин сбрасывает соединение), то можно прибегнуть к след. ухищрениям:

    1.1. Использовать только дампы. Подисываться на 50 матчей, при получении дампа отписываться и подписываться на след. матч. Тем самым можно реализовать сканер дампов. Однако, такой подход требует параллельного парсинга несколькими форками, поскольку в один поток нельзя распарсить дампы 250 лайв матчей за разумное время (3 секунды). Не использование диффов приводит к задержкам изменений, т.к. парсить дамп целиком затратнее, чем его часть.

    1.2. Использовать несколько коннектов в прелах одного процесса сканера. Теперь можно держать постоянное соединение большим кол-вом матчей и работать с диффами. Однако, поддержка нескольких коннектов в одном процессе плохо отражается на скорости забора данных из каждой очереди и в итоге сообщения в очередях в часы пик будут накапливаться, что неприемлемо. По идеи нельзя приступать к обработке/парсингу матчей пока очередь не будет разобрана, т.к. наличие сообщений в очереди говорит о наличии изменений, а все изменения должны быть применены. Все матчи хранятся в виде объектного дерева, а дифф накладывается на один из элементов, сбрасывая кеш парсинга родительского блока.

    1.3. Самый удачный вариант решения выше перечисленных проблем: использовать сбалансированные форки, где у каждого процесса будет по одному коннекту и ограниченному числу матчей. Матчи хранятся также как в п.1.2., но очередь разгребается за адекватное время даже при большом потоке событий. Итоговая версия обладает плюсами: не чувствительна к кол-ву матчей (если форков не хватает, то соддаются новые), у каждого форка не бывает ситуаций с переполнением очереди, каждый форк выполняет парсинг за минимальное время (кеш + ограниченное кол-во матчей)

2. Для работы с диффужином изначально была лишь официальная c-api библиотека. Потом была написана обертка для питона и позже для пхп. На сайте bet365 клиент диффужина реализован на флеше. Чтобы понять как общаться с сервером применялся wireshark для прослушивания tcp-пакетов.
